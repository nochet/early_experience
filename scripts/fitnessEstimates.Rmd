---
title: "Fitness estimates using invasibility models"
author: "Enoch Ng'oma"
date: "10/15/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(cowplot)
library(colorblindr)
library(forcats)
library(survival)
library(survminer)
library(demogR)

source("color_map.R")
source("ggplot_theme.R")
#source("color_map_blindr.R")
```

# Data

```{r}

# Fecundity
eggs <- read.table("~/MyGithub/early_experience/processed/tricount.txt",
            sep = '\t', header = TRUE)

zdn <-eggs %>%  
  select(id,sampleDate,age,cam_id,larvalTreat,adultTreat,
                NstartF,alive,numEggs,eggpDay,eggpFemDay) %>%
  rename(cageID=id,larval=larvalTreat,adult=adultTreat)

zdn$Diet <- gsub("\\d", "", zdn$cageID)
tail(zdn)
zdn$age <- zdn$age +2 # we added 2 days to each row of lifespan (see InitialProcess.R)

# Collapse replicates
zdn$age <- as.numeric(zdn$age) 

lh <- zdn %>%
  arrange(cageID, age) %>%
  group_by(Diet,cageID) %>%
  mutate(snum = row_number()) %>% # specify flip#
  as.data.frame()

lh$ad <- str_split(zdn$cageID, "_", simplify = TRUE)[,2]

lh <- lh %>%
  group_by(Diet,age) %>%
  summarize(n.eggs=mean(eggpFemDay),n=n()) %>%
  as.data.frame()

write.csv(lh,
          file = "../processed/eggDat_Leslie.csv",
          row.names = FALSE)


# Lifespan
eelife <- read.csv("../processed/eeAlldat.csv") %>%
  select(-X,cageID,larv_adult,larvalTreat,adultTreat,age,status,sex) 

eelife$age <- as.numeric(eelife$age)
eelife$status <- as.numeric(eelife$status)

eelifeF <- eelife %>%
  filter(sex=="F")

# Survival data for best lifespan model
mf4_data <- survfit(Surv(age, status) ~ larv_adult + strata(sex), eelifeF)

surv4 <- mf4_data %>%
  surv_summary(data = eelifeF) %>%
  rename(age = time, Diet = larv_adult) %>%
  select(Diet, 1:3,5,)

write.csv(surv4,
          file = "../processed/survDat_bestModelF.csv",
          row.names = FALSE)


# Combine fecundity and lifespan

# X=age class, 
# Sx=survivors, 
# Dx= death events, 
# lx=survival to age x, 
# Tx=eggs per female per day
# mx=number of eggs per female in age class X

surv_eggs <- inner_join(surv4,lh) 
  # rename(X="age",Sx="n.risk",Dx="n.event",lx="surv",Tx="n.eggs") %>%
  # select(-n)

  
# write.csv(surv_eggs,
#           file = "../processed/surv_eggs.csv",
#           row.names = FALSE)
# surv_eggs <- read.csv("../processed/surv_eggs.csv") 
```

# Life tables

```{r}
# rr <- surv_eggs %>% filter(Diet=="C_C") %>% select(n.risk,n.event) %>%
#   rename(count="n.risk",death="n.event") %>% mutate(age=0:31) %>% select(age,count,death)

cc <- surv_eggs %>% filter(Diet=="C_C") %>% 
  rename(count="n.risk",death="n.event",mx="n.eggs") %>% 
  select(-n) 
cc <- rbind(data.frame(Diet="C_C",age=0, count=426, death=0,surv=1,mx=0), cc)

cdr <- surv_eggs %>% filter(Diet=="C_DR") %>% 
  rename(count="n.risk",death="n.event",mx="n.eggs") %>% 
  select(-n) 
cdr <- rbind(data.frame(Diet="C_DR",age=0, count=393, death=0,surv=1,mx=0), cdr)

drc <- surv_eggs %>% filter(Diet=="DR_C") %>% 
  rename(count="n.risk",death="n.event",mx="n.eggs") %>% 
  select(-n) 
drc <- rbind(data.frame(Diet="DR_C",age=0, count=625, death=0,surv=1,mx=0), drc)

drdr <- surv_eggs %>% filter(Diet=="DR_DR") %>% 
  rename(count="n.risk",death="n.event",mx="n.eggs") %>% 
  select(-n) 
drdr <- rbind(data.frame(Diet="DR_DR",age=0, count=510, death=0,surv=1,mx=0), drdr)

# Life tables
cc.lt <- with(cc, life.table(x=age, nDx=death, nKx=count, type="cohort", iwidth=1, width12=c(1,1)))
cdr.lt <- with(cdr, life.table(x=age, nDx=death, nKx=count, type="cohort", iwidth=1, width12=c(1,1)))
drc.lt <- with(drc, life.table(x=age, nDx=death, nKx=count, type="cohort", iwidth=1, width12=c(1,1)))
drdr.lt <- with(drdr, life.table(x=age, nDx=death, nKx=count, type="cohort", iwidth=1, width12=c(1,1)))

# View function
#getAnywhere(life.table) # iwidth and width12!!!

```

# Create matices

```{r}
# nKx = mid-interval ppn str
# nLx = age-specific survival
# mx = age-specific fertility

cc.mx <- cc.lt %>% select(x,nLx) %>% rename(age="x") %>%  inner_join(cc) %>% select(1,3:7,2) 
cc.lmat <- leslie.matrix(lx=cc.mx$nLx, mx=cc.mx$mx)
cc.eig <- eigen.analysis(cc.lmat)

cdr.mx <- cdr.lt %>% select(x,nLx) %>% rename(age="x") %>%  inner_join(cdr) %>% select(1,3:7,2) 
cdr.lmat <- leslie.matrix(lx=cdr.mx$nLx, mx=cc.mx$mx)

drc.mx <- cc.lt %>% select(x,nLx) %>% rename(age="x") %>%  inner_join(cc) %>% select(1,3:7,2) 
drc.lmat <- leslie.matrix(lx=drc.mx$nLx, mx=cc.mx$mx)

drdr.mx <- cc.lt %>% select(x,nLx) %>% rename(age="x") %>%  inner_join(cc) %>% select(1,3:7,2) 
drdr.lmat <- leslie.matrix(lx=drdr.mx$nLx, mx=cc.mx$mx)



# Diets C_C C_DR DR_C DR_DR
rr <- surv_eggs %>% filter(Diet=="C_C") %>% select(age,surv,n.eggs) %>%
  rename(surv.rr="surv",fec.rr="n.eggs") 
rr <- rbind(data.frame(age = 0, surv.rr = 1, fec.rr=0), rr)

rp <- surv_eggs %>% filter(Diet=="C_DR") %>% select(age,surv,n.eggs) %>%
  rename(surv.rr="surv",fec.rr="n.eggs") 
pr <- surv_eggs %>% filter(Diet=="DR_C") %>% select(age,surv,n.eggs) %>%
  rename(surv.rr="surv",fec.rr="n.eggs") 
pp <- surv_eggs %>% filter(Diet=="DR_DR") %>% select(age,surv,n.eggs) %>%
  rename(surv.rr="surv",fec.rr="n.eggs") 

```


```{r}

  
dat.wide <- surv_eggs %>%
  pivot_wider(id_cols = 1:6,
              names_from = Diet,
              values_from = c(n.risk,n.event,surv,n.eggs),
              values_fill = FALSE
                        ) %>%
  as.data.frame()


# Diets C_C C_DR DR_C DR_DR
rr <- surv_eggs %>% filter(Diet=="C_C") %>% select(age,surv,n.eggs) %>%
  rename(surv.rr="surv",fec.rr="n.eggs") 
rr <- rbind(data.frame(age = 0, surv.rr = 1, fec.rr=0), rr)

rp <- surv_eggs %>% filter(Diet=="C_DR") %>% select(age,surv,n.eggs) %>%
  rename(surv.rr="surv",fec.rr="n.eggs") 
pr <- surv_eggs %>% filter(Diet=="DR_C") %>% select(age,surv,n.eggs) %>%
  rename(surv.rr="surv",fec.rr="n.eggs") 
pp <- surv_eggs %>% filter(Diet=="DR_DR") %>% select(age,surv,n.eggs) %>%
  rename(surv.rr="surv",fec.rr="n.eggs") 

```



```{r}
utreats <- unique(surv_eggs$Diet)

surv_eggs$Sx <- rep(NA,nrow(surv_eggs))
surv_eggs$Fx <- rep(NA,nrow(surv_eggs))

surv_eggs.t <- surv_eggs[0,]

for (k in utreats) {
  surv_eggs.s <- subset(surv_eggs, Diet==k)
  for(i in 1:nrow(surv_eggs.s)) {
    surv_eggs$ageclass <- 1:k
    if(i==1) {
      surv_eggs.s[i,'x'] <- surv_eggs.s$
    surv_eggs.s[i,'x'] <- surv_eg.s[(i-1),'x']
    }
  }
  
}
fitnCols <- 
surv_eggs <- surv_eggs %>%
  as_tibble() %>%
  group_by(Diet) %>%
  group_modify(~ add_row(.x, .before = 0))

fE <- (n.eggs/(age*3))*(24*(age))
```


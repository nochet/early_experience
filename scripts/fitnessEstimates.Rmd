---
title: "Fitness estimates using invasibility models"
author: "Enoch Ng'oma"
date: "10/15/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(cowplot)
library(colorblindr)
library(forcats)
library(survival)
library(survminer)
library(demogR)

source("color_map.R")
source("ggplot_theme.R")
#source("color_map_blindr.R")

# Function to drop +0i from complex numbers
f <- function(x) {
   if (all(Im(z <- zapsmall(x))==0)) as.numeric(z) else x
}
```

# Data

```{r}

# Fecundity
eggs <- read.table("~/MyGithub/early_experience/processed/tricount.txt",
            sep = '\t', header = TRUE)

zdn <-eggs %>%  
  select(id,sampleDate,age,cam_id,larvalTreat,adultTreat,
                NstartF,alive,numEggs,eggpDay,eggpFemDay) %>%
  rename(cageID=id,larval=larvalTreat,adult=adultTreat)

zdn$Diet <- gsub("\\d", "", zdn$cageID)
tail(zdn)
zdn$age <- zdn$age +2 # we added 2 days to each row of lifespan (see InitialProcess.R)

# Collapse replicates
zdn$age <- as.numeric(zdn$age) 

lh <- zdn %>%
  arrange(cageID, age) %>%
  group_by(Diet,cageID) %>%
  mutate(snum = row_number()) %>% # specify flip#
  as.data.frame()

lh$ad <- str_split(zdn$cageID, "_", simplify = TRUE)[,2]

lf <- lh %>%
  group_by(Diet,age) %>%
  summarize(n.eggs=mean(eggpFemDay),n=n()) %>%
  as.data.frame()

write.csv(lf,
          file = "../processed/eggDat_Leslie.csv",
          row.names = FALSE)

lf %>%
  group_by(Diet) %>%
  summarize(m.eggs=mean(n.eggs),n=n()) %>%
  as.data.frame()

lf$Diet <- factor(lf$Diet)
pairwise.t.test(lf$n.eggs, lf$Diet)


# Lifespan
eelife <- read.csv("../processed/eeAlldat.csv") %>%
  select(-X,cageID,larv_adult,larvalTreat,adultTreat,age,status,sex) 

eelife$age <- as.numeric(eelife$age)
eelife$status <- as.numeric(eelife$status)

eelifeF <- eelife %>%
  filter(sex=="F")

# Survival data for best lifespan model
mf4_data <- survfit(Surv(age, status) ~ larv_adult + strata(sex), eelifeF)

surv4 <- mf4_data %>%
  surv_summary(data = eelifeF) %>%
  rename(age = time, Diet = larv_adult) %>%
  select(Diet, 1:3,5,)

write.csv(surv4,
          file = "../processed/survDat_bestModelF.csv",
          row.names = FALSE)


# Combine fecundity and lifespan

# X=age class, 
# Sx=survivors, 
# Dx= death events, 
# lx=survival to age x, 
# Tx=eggs per female per day
# mx=number of eggs per female in age class X

surv_eggs <- inner_join(surv4,lh) 
  # rename(X="age",Sx="n.risk",Dx="n.event",lx="surv",Tx="n.eggs") %>%
  # select(-n)

  
# write.csv(surv_eggs,
#           file = "../processed/surv_eggs.csv",
#           row.names = FALSE)
# surv_eggs <- read.csv("../processed/surv_eggs.csv") 
```

# Life tables

```{r}
# Add row for zero mortality and fecundity before first age class
# Add row for zero survival and fecundity at the end of experiment

cc <- surv_eggs %>% filter(Diet=="C_C") %>% 
  rename(count="n.risk",death="n.event",mx="n.eggs") %>% select(-n) 
cc <- rbind(data.frame(Diet="C_C",age=0, count=426, death=0,surv=1,mx=0), cc)
cc <- rbind(cc, data.frame(Diet="C_C",age=80, count=0, death=0,surv=0,mx=0))

cdr <- surv_eggs %>% filter(Diet=="C_DR") %>% 
  rename(count="n.risk",death="n.event",mx="n.eggs") %>% select(-n) 
cdr <- rbind(data.frame(Diet="C_DR",age=0, count=393, death=0,surv=1,mx=0), cdr)
cdr <- rbind(cdr, data.frame(Diet="C_DR",age=78, count=0, death=0,surv=0,mx=0))

drc <- surv_eggs %>% filter(Diet=="DR_C") %>% 
  rename(count="n.risk",death="n.event",mx="n.eggs") %>% select(-n) 
drc <- rbind(data.frame(Diet="DR_C",age=0, count=625, death=0,surv=1,mx=0), drc)
drc <- rbind(drc, data.frame(Diet="DR_C",age=78, count=0, death=0,surv=0,mx=0))

drdr <- surv_eggs %>% filter(Diet=="DR_DR") %>% 
  rename(count="n.risk",death="n.event",mx="n.eggs") %>% 
  select(-n) 
drdr <- rbind(data.frame(Diet="DR_DR",age=0, count=510, death=0,surv=1,mx=0), drdr)
drdr <- rbind(drdr, data.frame(Diet="dr_DR",age=80, count=0, death=0,surv=0,mx=0))

# Life tables
cc.lt <- with(cc, life.table(x=age, nDx=death, nKx=count, type="cohort", iwidth=1, width12=c(1,1)))
cdr.lt <- with(cdr, life.table(x=age, nDx=death, nKx=count, type="cohort", iwidth=1, width12=c(1,1)))
drc.lt <- with(drc, life.table(x=age, nDx=death, nKx=count, type="cohort", iwidth=1, width12=c(1,1)))
drdr.lt <- with(drdr, life.table(x=age, nDx=death, nKx=count, type="cohort", iwidth=1, width12=c(1,1)))

# View function
#getAnywhere(life.table) # iwidth and width12!!!

```

# Create matices

```{r}
# nKx = mid-interval ppn str
# nLx = age-specific survival
# mx = age-specific fertility

cc.mx <- cc.lt %>% select(x,nLx) %>% rename(age="x") %>%  inner_join(cc) %>% select(1,3:7,2) 
cc.lmat <- leslie.matrix(lx=cc.mx$nLx, mx=cc.mx$mx)
cc.eig <- eigen.analysis(cc.lmat)

cdr.mx <- cdr.lt %>% select(x,nLx) %>% rename(age="x") %>%  inner_join(cdr) %>% select(1,3:7,2) 
cdr.lmat <- leslie.matrix(lx=cdr.mx$nLx, mx=cdr.mx$mx)
cdr.eig <- eigen.analysis(cdr.lmat)

drc.mx <- cc.lt %>% select(x,nLx) %>% rename(age="x") %>%  inner_join(drc) %>% select(1,3:7,2) 
drc.lmat <- leslie.matrix(lx=drc.mx$nLx, mx=drc.mx$mx)
drc.eig <- eigen.analysis(drc.lmat)

drdr.mx <- cc.lt %>% select(x,nLx) %>% rename(age="x") %>%  inner_join(drdr) %>% select(1,3:7,2) 
drdr.lmat <- leslie.matrix(lx=drdr.mx$nLx, mx=drdr.mx$mx)
drdr.eig <- eigen.analysis(drdr.lmat)

# Plot sensitivities and elasticities
par(mfrow=c(3,4))
plot(cc.eig$sensitivities)
title("a")
plot(cdr.eig$sensitivities)
title("b")
plot(drc.eig$sensitivities)
title("c")
plot(drdr.eig$sensitivities)
title("d")

plot(cc.eig$elasticities)
title("e")
plot(cdr.eig$elasticities)
title("f")
plot(drc.eig$elasticities)
title("g")
plot(drdr.eig$elasticities)
title("h")

plot(cc.eig$repro.value)
title("i")
plot(cdr.eig$repro.value)
title("j")
plot(drc.eig$repro.value)
title("k")
plot(drdr.eig$repro.value)
title("l")

# Reproductive values
cc.age <- surv_eggs %>% filter(Diet=="C_C") %>% select(age) 
cc.rv <- as.data.frame(cbind(cc.eig$stable.age,cc.eig$repro.value)) %>%
  rename(stable_age="V1", Rvalue="V2") %>%
  cbind(cc.age)

ccpl <- ggplot(cc.rv, aes(age,Rvalue)) +
  geom_point() +
  geom_smooth() +
  labs(x = "Age (days)", y = "Reproductive value") +
  theme_half_open() +
  my_theme
ccpl <- ccpl + ggtitle("C_C")

cdr.age <- surv_eggs %>% filter(Diet=="C_DR") %>% select(age) 
cdr.rv <- as.data.frame(cbind(cdr.eig$stable.age,cdr.eig$repro.value)) %>%
  rename(stable_age="V1", Rvalue="V2") %>%
  cbind(cdr.age)

cdrpl <- ggplot(cdr.rv, aes(age,Rvalue)) +
  geom_point() +
  geom_smooth() +
  labs(x = "Age (days)", y = "Reproductive value") +
  theme_half_open() +
  my_theme
cdrpl <- cdrpl + ggtitle("C_DR")
          
drc.age <- surv_eggs %>% filter(Diet=="DR_C") %>% select(age) 
drc.rv <- as.data.frame(cbind(drc.eig$stable.age,drc.eig$repro.value)) %>%
  rename(stable_age="V1", Rvalue="V2") %>%
  cbind(drc.age)

drcpl <- ggplot(drc.rv, aes(age,Rvalue)) +
  geom_point() +
  geom_smooth() +
  labs(x = "Age (days)", y = "Reproductive value") +
  theme_half_open() +
  my_theme
drcpl <- drcpl + ggtitle("DR_C")

drdr.age <- surv_eggs %>% filter(Diet=="DR_DR") %>% select(age) 
drdr.rv <- as.data.frame(cbind(drdr.eig$stable.age,drdr.eig$repro.value)) %>%
  rename(stable_age="V1", Rvalue="V2") %>%
  cbind(drdr.age)

drdrpl <- ggplot(drdr.rv, aes(age,Rvalue)) +
  geom_point() +
  geom_smooth() +
  labs(x = "Age (days)", y = "Reproductive value") +
  theme_half_open() +
  my_theme
drdrpl <- drdrpl + ggtitle("DR_DR")

library(ggpubr)
fitn <- ggarrange(ccpl,cdrpl,drcpl,drdrpl, ncol = 2, nrow = 2, 
                 labels = c("a", "b","c"))

ggsave(fitn,file = "../plots/leslie_fitness.pdf",
                width = 4,height=4)

c(cc.eig$lambda1,cc.eig$rho)
c(cdr.eig$lambda1,cdr.eig$rho)
c(drc.eig$lambda1,drc.eig$rho)
c(drdr.eig$lambda1,drdr.eig$rho)
```



---
title: "Early Experience Factorial Experiment"
author: "Enoch Ng'oma"
date: "7/4/2018"
output:
  html_document:
    theme: flatly
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
---

# Analysis of diet-dependent developmental plasticity in D. melanogaster lifespan

# Load packages

```{r}
library(survival)
library(survminer)
library(splines)
library(tidyverse) 
library(forcats)
library(cowplot)
library(colorblindr)
library(visR)
#library(Greg)


#source("color_map.R")
source("ggplot_theme.R")
```
# An R Package for ANOVA
```{r}
# library(ExpDes)
```

## Load data & combine female and male events

```{r}
# Female data
eelifeF <- read.table('../processed/Female_events_eelife.txt',
                     sep = "\t", header = TRUE,
                     stringsAsFactors = FALSE) 

eelifeF <- select(eelifeF, -setDate, -flipDate, -age)
names(eelifeF)[1:2]<-c("age", "cageID")
eelifeF$sex <- "F"

# Male data
eelifeM <- read.table('../processed/Male_events_eelife.txt',
                     sep = "\t", header = TRUE,
                     stringsAsFactors = FALSE) 

eelifeM <- select(eelifeM, -setDate, -flipDate, -age)
names(eelifeM)[1:2]<-c("age", "cageID")
eelifeM$sex <- "M"
  
eelife <- rbind(eelifeF,eelifeM)
  

#eelife$carried <- 0 
eelife <- na.omit(eelife)

eelife$status <- ifelse(eelife[,"status"] == 2, 1, 0)

write.csv(eelife, file="../processed/eeAlldat.csv, row.names = FALSE")
```

# Testing developmental theories

## a) Survival
#### Males and females together
#### Females alone
#### Males alone
## b) Reaction norms


# Male and female combined

```{r}

eelife <- read.csv("../processed/eeAlldat.csv") %>%
  select(-X)

# Look at distribution of events
eelife <- eelife %>% 
  mutate(stats = ifelse(status == 2, 1, 0)) %>%
  select(cageID,larvalTreat,adultTreat,age,status,sex)

eelife <- unite(eelife, larv_adult,larvalTreat,adultTreat,sep = "_",remove = FALSE)

mp <- survfit(Surv(age, status) ~ larvalTreat + adultTreat,
                   conf.type = "log", 
                   conf.int = 0.95,
                   type = "kaplan-meier",
                   error = "greenwood",
                   data = eelife)

mp
summary(mp)$table[, "median"]

mp.plot <- ggsurvplot(mp, data = eelife, 
                     conf.int = FALSE,
                     break.time.by = 20,
                     #palette = "palette_OkabeIto",
                     palette = c("#999999", "#E69F00", 
                                 "#56B4E9", "#009E73"),
                     fun = "pct", 
                     pval = TRUE,
                     surv.median.line = "hv",
                     fontsize = 4.5,
                     font.x = 14,
                     font.y = 14,
                     # font.tickslab = 11,
                     # font.main = 11,
                     #risk.table = FALSE,
                     legend = c(0.9, 0.6),
                     risk.table = TRUE,
                     risk.table.col = "strata",
                     #risk.table.fontsize = 4,
                     tables.height = 0.4,
                     #tables.theme = theme_cleantable(),
                    # title = "Females & Males",
                     legend.labs = c("C-C","C-DR","DR-C","DR-DR"),
                     legend.title = "Diet \n combination") +
                     guides(colour = guide_legend(nrow = 4)) +
  xlab("Age (days)")
mp.plot

ggsave(filename = "~/MyGithub/early_experience/plots/SurvPlots_for_fullModel_with_RiskTable_All.pdf", height=6, width=6, plot=mp.plot)

survdiff(Surv(age) ~larvalTreat + adultTreat, 
                     data = eelife, rho = 0) 

quantile(mp,  probs = c(0.1, 0.5, 0.9))
visR::get_quantile(mp, probs = c(0.1, 0.5, 0.9))

mps <- surv_fit(Surv(age, status) ~ larvalTreat + adultTreat,
                   data = eelife,group.by="sex")
surv_pvalue(mps)

mpc <- surv_fit(Surv(age, status) ~ sex,
                   data = eelife,group.by="larv_adult")
surv_pvalue(mpc)

# Extract summary table at interesting probabilities
mpsum <- summary(mp,probs=c(0.1,0.5,0.9))
#summary(mp,times=c(1,2,3))

ggsave(jx,file = "~/MyGithub/early_experience/plots/Quantplots_thumbnail.pdf",
  width = 4,
  height = 2)
```

##################
```{r}
mp <- survfit(Surv(age, status) ~ larvalTreat + adultTreat,
                  group_by = "sex",
                   data = eelife)

mpsum <- summary(mp,probs=c(0.1,0.5,0.9))
cols <- lapply(c(2:7, 10,15:16) , function(x) mpsum[x])
mptab <- do.call(data.frame, cols)
mptab$surv <- round(mptab$surv,digits = 1)
head(mptab)

mpfilt <- subset(mptab, surv %in% c(0.9,0.5,0.1))
mpfilt$strata <- gsub(",[^=]+=", "_",mpfilt$strata) # remove everything between ',' and '=', add '_'
mpfilt$Diet <- gsub(".*=","",mpfilt$strata) # remove everything before '='

```
###################

```{r}
mf <- survfit(Surv(age, status) ~ larvalTreat + adultTreat + sex,
                   conf.type = "log", 
                   conf.int = 0.95,
                   type = "kaplan-meier",
                   error = "greenwood",
                   data = eelife)
#summary(mf)
summary(mf)$table[, "median"]
#sum_survfit <- surv_summary(mf, data = eelife)

write.csv(sum_survfit, 
          file = "../processed/SummarySurvModel_larvAdulSex.csv",
          row.names = FALSE) 

# Write quantiles
write.csv(quantile(mf, probs = c(0.25, 0.5, 0.75)), 
          file = "../processed/quantiles.csv")

# OkabeIto palette in Hex: "#000000","#E69F00","#56B4E9",
# "#009E73", #F0E442","#0072B2","#D55E00","#CC79A7"

mf.plot <- ggsurvplot(mf, data = eelife, 
                     conf.int = FALSE,
                     break.time.by = 20,
                     #palette = "palette_OkabeIto",
                     palette = c("#999999", "#E69F00", "#56B4E9", "#009E73", 
                       "#F0E442", "#0072B2", "#D55E00", "#CC79A7"),
                     fun = "pct", 
                     surv.median.line = "hv",
                     #fontsize = 3.5,
                     #font.main = 3.5,
                     #font.x = 12,
                     #font.y = 12,
                     # font.tickslab = 11,
                     pval = TRUE,
                     #font.main = 12,
                     legend = c(0.9, 0.6),
                     risk.table = TRUE,
                     risk.table.col = "strata",
                     risk.table.fontsize = 3.5,
                     tables.height = 0.35,
                     tables.theme = theme_cleantable(),
                    # title = "Females & Males",
                     legend.labs = c("C-C-F","C-C-M",
                                     "C-DR-F","C-DR-M",
                                     "DR-C-F","DR-C-M",
                                     "DR-DR-F","DR-DR-M"),
                     legend.title = "Diet-Sex \n combination") +
                     guides(colour = guide_legend(nrow = 8)) +
                     xlab("Age (days)")
mf.plot


ggsave(filename = "~/MyGithub/early_experience/plots/SurvPlots_for_fullModel_with_RiskTable_Sex.png", last_plot(),device = "png")

# Test significance
survdiff(Surv(age) ~larvalTreat+adultTreat+sex,
                     data = eelife, rho = 0) 

quantile(mf,  probs = c(0.1, 0.5, 0.9))
```

##################
```{r}
mfsum <- summary(mf,probs=c(0.1,0.5,0.9))
cols <- lapply(c(2:7, 10,15:16) , function(x) mfsum[x])
mftab <- do.call(data.frame, cols)
mftab$surv <- round(mftab$surv,digits = 1)
head(mftab)

mfilt <- subset(mftab, surv %in% c(0.9,0.5,0.1))
mfilt$strata <- gsub(",[^=]+=", "_",mfilt$strata) # remove everything between ',' and '=', add '_'
mfilt$Diet <- gsub(".*=","",mfilt$strata) # remove everything before '='

# Aggregate by treatment
#mpfilt$strata <- as.factor(mpfilt$strata)
mfeval <- mfilt %>%
  group_by(Diet,surv) %>%
  summarise_at(c("time", "std.err", "lower", "upper"), mean, na.rm = TRUE)

jx <- ggplot(mpeval, aes(x=surv, y=time, group=Diet, color=Diet)) + 
  #geom_line() +
  geom_point(alpha=0.6)+
  geom_errorbar(aes(ymin=surv-std.err, ymax=surv+std.err),alpha=0.6) +
  #scale_colour_discrete("Diet \n combination") +
  facet_grid(cols=vars(Diet), rows=vars(surv), scales= "free_y") +
  scale_x_continuous(limits = c(0, 80), breaks = seq(0, 80, by = 25)) +
  scale_color_manual(values=c("#999999", "#E69F00","#56B4E9", "#009E73")) +
  labs(x = "Age (days)", y = "Quantile survival") +
  theme(legend.position = "none") +
  my_theme +
  theme_half_open()
jx

ggsave(jx,file = "~/MyGithub/early_experience/plots/Quantplots_thumbnail.pdf",
  width = 4,
  height = 2)

```
###################

# EarlyRich (C diet) 

### Females only

```{r}
earlyRichF <- subset(eelife, c(eelife$larvalTreat=="C" & eelife$sex=="F"))

erf <- survfit(Surv(age, status) ~ adultTreat,
                   conf.type = "log", 
                   conf.int = 0.95,
                   type = "kaplan-meier",
                   error = "greenwood",
                   data = earlyRichF)

summary(erf)$table[, "median"]

erf.plot <- ggsurvplot(erf, data = earlyRichF, 
                     conf.int = FALSE,
                     break.time.by = 20,
                     palette = c("#999999", "#E69F00", 
                                 "#56B4E9", "#009E73"),
                     fun = "pct", 
                     surv.median.line = "hv",
                     font.x = 10,
                     font.y = 10,
                     font.tickslab = 10,
                     font.main = 10,
                     risk.table = FALSE,
                     #legend="none",
                     legend = c(0.9, 0.8),                     
                     title = "Larval-C; Females",
                     legend.labs = c("C", "DR"),
                     legend.title = "Adult Diet") +
  xlab("Age (days)") 
erf.plot

# Test significance
survdiff(Surv(age, status) ~ adultTreat,
                     data = earlyRichF, rho = 0) 

#quantile(f_er1,  probs = c(0.1, 0.5, 0.9))

```

# EarlyRich (C diet) 

### Males only

```{r}
earlyRichM <- subset(eelife, c(eelife$larvalTreat=="C" & eelife$sex=="M"))

erm <- survfit(Surv(age, status) ~ adultTreat,
                   conf.type = "log", 
                   conf.int = 0.95,
                   type = "kaplan-meier",
                   error = "greenwood",
                   data = earlyRichM)

summary(erm)$table[, "median"]

erm.plot <- ggsurvplot(erm, data = earlyRichM, 
                     conf.int = FALSE,
                     break.time.by = 30,
                     palette = c("#999999", "#E69F00", 
                                 "#56B4E9", "#009E73"),
                     fun = "pct", 
                     surv.median.line = "hv",
                     font.x = 10,
                     font.y = 10,
                     font.tickslab = 10,
                     font.main = 10,
                     risk.table = FALSE,
                     legend="none",
                     # legend = c(0.9, 0.8),                     
                     # legend.labs = c("C", "DR"),
                     legend.title="",
                     title = "Larval-C; Males") +
  xlab("Age (days)") 
erm.plot

survdiff(Surv(age) ~ adultTreat,
                     data = earlyRichM, rho = 0) 

```

# EarlyPoor (DR diet) 

### Females only

```{r}
earlyPoorF <- subset(eelife, c(eelife$larvalTreat=="DR" & eelife$sex=="F"))

epf <- survfit(Surv(age, status) ~ adultTreat,
                   conf.type = "log", 
                   conf.int = 0.95,
                   type = "kaplan-meier",
                   error = "greenwood",
                   data = earlyPoorF,)
summary(epf)$table[, "median"]

epf.plot <- ggsurvplot(epf, data = earlyPoorF, 
                     conf.int = FALSE,
                     break.time.by = 20,
                     palette = c("#999999", "#E69F00", 
                                 "#56B4E9", "#009E73"),
                     fun = "pct", 
                     surv.median.line = "hv",
                     font.x = 10,
                     font.y = 10,
                     font.tickslab = 10,
                     font.main = 10,
                     risk.table = FALSE,
                     legend="none",
                     # legend = c(0.9, 0.8),                     
                     # legend.labs = c("C", "DR"),
                     # legend.title = "Adult Diet",
                     title = "Larval-DR; Females") +
  xlab("Age (days)") +
  ylab("")
epf.plot

# Test significance
survdiff(Surv(age, status) ~ adultTreat,
                     data = earlyPoorF, rho = 0) 

#quantile(f_er1,  probs = c(0.1, 0.5, 0.9))

```

### Males only

```{r}
earlyPoorM <- subset(eelife, c(eelife$larvalTreat=="DR" & eelife$sex=="M"))

epm <- survfit(Surv(age, status) ~ adultTreat,
                   conf.type = "log", 
                   conf.int = 0.95,
                   type = "kaplan-meier",
                   error = "greenwood",
                   data = earlyPoorM)

summary(epm)$table[, "median"]

epm.plot <- ggsurvplot(epm, data = earlyPoorM, 
                     conf.int = FALSE,
                     break.time.by = 20,
                     palette = c("#999999", "#E69F00", 
                                 "#56B4E9", "#009E73"),
                     fun = "pct", 
                     surv.median.line = "hv",
                     font.x = 10,
                     font.y = 10,
                     font.tickslab = 10,
                     font.main = 10,
                     risk.table = FALSE,
                     legend="none",
                     # legend = c(0.9, 0.8),                     
                     # legend.labs = c("C", "DR"),
                     # legend.title = "Adult Diet",
                     title = "Larval-DR; Males") +
  xlab("Age (days)") +
  ylab("")
epm.plot

survdiff(Surv(age, status) ~ adultTreat,
                     data = earlyPoorM, rho = 0) 
```

# Arrange plots

```{r}
splots <- list()
splots[[1]] <- erf.plot
splots[[2]] <- erm.plot
splots[[3]] <- epf.plot
splots[[4]] <- epm.plot

splots_out <- arrange_ggsurvplots(
  splots,
  print = FALSE,
  ncol = 2,
  nrow = 2)
#ggpar(splots_out, font.main=10)

ggsave(
  splots_out,
  file = "~/MyGithub/early_experience/plots/SurvPlots_for_larvalDiet.pdf",
  width = 6,
  height = 5)
```






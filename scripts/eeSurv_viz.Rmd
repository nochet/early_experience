---
title: "Early Experience Factorial Experiment"
author: "Enoch Ng'oma"
date: "7/4/2018"
output:
  html_document:
    theme: flatly
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
---

# Analysis of diet-dependent developmental plasticity in D. melanogaster lifespan

# Load packages

```{r}
library(survival)
library(survminer)
library(splines) #needed by survival package
library(tidyverse) 
library(forcats)
library(cowplot)
library(Greg)
#library(coxme)
#library(brms)

source("color_map.R")
source("ggplot_theme.R")
```

## Load data & combine female and male events

```{r}
# Female data
eelifeF <- read.table('../processed/Female_events_eelife.txt',
                     sep = "\t", header = TRUE,
                     stringsAsFactors = FALSE) 

eelifeF <- select(eelifeF, -setDate, -flipDate, -age)
names(eelifeF)[1:2]<-c("age", "cageID")
eelifeF$sex <- "F"

# Male data
eelifeM <- read.table('../processed/Male_events_eelife.txt',
                     sep = "\t", header = TRUE,
                     stringsAsFactors = FALSE) 

eelifeM <- select(eelifeM, -setDate, -flipDate, -age)
names(eelifeM)[1:2]<-c("age", "cageID")
eelifeM$sex <- "M"
  
eelife <- rbind(eelifeF,eelifeM)
  

#eelife$carried <- 0 
eelife <- na.omit(eelife)

write.csv(eelife, file="../processed/eeAlldat.csv")
```

# Descriptives

```{r, dens}
cohort <- c('F&M','FF','MM')

dens.list <- vector(mode='list', length=3)
names(dens.list) <- cohort

for (ii in cohort) {
  
if(ii=='F&M')
{
# Male and female together

pp <- ggplot(eelife, aes(age, color = larv_adult)) + 
    geom_density(alpha = 0.5) +
    coord_cartesian(xlim = c(-10, 120), ylim = c(0, 0.03)) + 
    #adjust frame of x-axis
  
    scale_x_continuous(expand = c(0, 0), limits = c(-10, 120)) +
    expand_limits(x=125) +
    #limit plot area on x-axis
  
    scale_y_continuous(expand = c(0, 0)) +
    tx_color_map() +
    theme(axis.title = element_text(size = 12)) +
    xlab("Age (days)") +
    ylab("Density") +
    theme_half_open() +
    theme(legend.position = "none") 

    #element.text = 12
    #tx_fill_map() +
    #my_theme
#fm
}
  
if(ii=='FF')
  
{

# Female alone

pp <- ggplot(eelifeF, aes(age, color = larv_adult)) + 
    geom_density(alpha = 0.5) +
    coord_cartesian(xlim = c(-10, 120), ylim = c(0, 0.03)) + 
    #adjust frame of x-axis
    scale_x_continuous(expand = c(0, 0), limits = c(-10, 120)) +
    expand_limits(x=125) +
    #limit plot area on x-axis
    scale_y_continuous(expand = c(0, 0)) +
    tx_color_map() +
    theme(axis.title = element_text(size = 12)) +
    xlab("Age (days)") +
    ylab("Density") +
    theme_half_open() +
    theme(legend.position = "none") 
#ff

}
  
if(ii=='MM')

{
# Male alone

pp <- ggplot(eelifeM, aes(age, color = larv_adult)) + 
    geom_density(alpha = 0.5) +
    coord_cartesian(xlim = c(-10, 120), ylim = c(0, 0.03)) + 
    #adjust frame of x-axis
    scale_x_continuous(expand = c(0, 0), limits = c(-10, 120)) +
    expand_limits(x=125) +
    #limit plot area on x-axis
    scale_y_continuous(expand = c(0, 0)) +
    tx_color_map() +
    theme(axis.title = element_text(size = 12)) +
    xlab("Age (days)") +
    ylab("Density") +
    theme_half_open() +
    theme(legend.position = c(0.7, 0.8)) 
#mm
}
dens.list[[ii]] <- pp
}

densPlot <- plot_grid(dens.list[[1]],dens.list[[2]],dens.list[[3]],
                      nrow =3, ncol=1, 
                      labels = c('a.', 'b.', 'c.'), 
                      align = 'h', 
                      rel_widths = c(1.5,1.5, 1.5), 
                      label_size = 10)

ggsave(last_plot(), file = "../plots/density_male_female.pdf",
       width = 6, height = 4)
```

# Testing developmental theories

## a) Survival
#### Males and females together
#### Females alone
#### Males alone
## b) Reaction norms


# Male and female combined

```{r}
# Model
eelife <- read.csv("../processed/eeAlldat.csv")

# Look at distribution of events
eelife <- eelife %>% 
  mutate(stats = ifelse(status == 2, 1, 0))

surv <- Surv(eelife$age, eelife$stats)
ggsurvevents(surv, normalized = TRUE, type="fraction", 
             censored.on.top = TRUE,
             ggtheme = theme_survminer(title = "blank"))

mf <- survfit(Surv(age, status == 2) ~ adultTreat,
                   conf.type = "log", 
                   conf.int = 0.95,
                   type = "kaplan-meier",
                   error = "greenwood",
                   data = eelife)

summary(mf)$table[, "median"]


mf.plot <- ggsurvplot(mf, data = eelife, 
                     conf.int = FALSE,
                     palette = c("#999999", "#E69F00", 
                                 "#56B4E9", "#009E73"),
                     fun = "pct", 
                     surv.median.line = "hv",
                    # font.y = c(14),
                     font.x = c(font_size),
                     font.y = c(font_size),
                     font.tickslab = c(font_size),
                     font.main = 12,
                     risk.table = FALSE,
                     legend = c(0.9, 0.8),
                     title = "Females & Males",
                     legend.labs = c("C", "DR"),
                     legend.title = "Adult Diet") +
                     theme_survminer(font.main = 12)  +
  xlab("Age (days)")
mf.plot

# Test significance
survdiff(Surv(age) ~ adultTreat,
                     data = eelife, rho = 0) 

quantile(mf,  probs = c(0.1, 0.5, 0.9))
```

# EarlyRich (C diet) 

### Females only

```{r}
earlyRichF <- subset(eelifeF, eelifeF$larvalTreat=="C")

erf <- survfit(Surv(age, status == 2) ~ adultTreat,
                   conf.type = "log", 
                   conf.int = 0.95,
                   type = "kaplan-meier",
                   error = "greenwood",
                   data = earlyRichF)

summary(erf)$table[, "median"]

erf.plot <- ggsurvplot(erf, data = earlyRichF, 
                     conf.int = FALSE,
                     palette = c("#999999", "#E69F00", 
                                 "#56B4E9", "#009E73"),
                     fun = "pct", 
                     surv.median.line = "hv",
                     font.x = c(font_size),
                     font.y = c(font_size),
                     font.tickslab = c(font_size),
                     font.main = 12,
                     risk.table = FALSE,
                     legend = c(0.9, 0.8),                     
                     title = "Early-Rich Females",
                     legend.labs = c("C", "DR"),
                     legend.title = "Adult Diet") +
  theme_survminer(font.main = 12)  +
  xlab("Age (days)")
erf.plot

# Test significance
survdiff(Surv(age, status==2) ~ adultTreat,
                     data = earlyRichF, rho = 0) 

quantile(f_er1,  probs = c(0.1, 0.5, 0.9))

```

# EarlyRich (C diet) 

### Males only

```{r}
earlyRichM <- subset(eelifeM, eelifeM$larvalTreat=="C")

erm <- survfit(Surv(age, status == 2) ~ adultTreat,
                   conf.type = "log", 
                   conf.int = 0.95,
                   type = "kaplan-meier",
                   error = "greenwood",
                   data = earlyRichM)

summary(erm)$table[, "median"]

erm.plot <- ggsurvplot(erm, data = earlyRichM, 
                     conf.int = FALSE,
                     palette = c("#999999", "#E69F00", 
                                 "#56B4E9", "#009E73"),
                     fun = "pct", 
                     surv.median.line = "hv",
                     font.x = c(font_size),
                     font.y = c(font_size),
                     font.tickslab = c(font_size),
                     font.main = 12,
                     risk.table = FALSE,
                     legend = c(0.9, 0.8),                     
                     title = "Early-Rich Males",
                     legend.labs = c("C", "DR"),
                     legend.title = "Adult Diet") +
  theme_survminer(font.main = 12) +
  xlab("Age (days)")
erm.plot

survdiff(Surv(age) ~ adultTreat,
                     data = earlyRichM, rho = 0) 

```

# EarlyPoor (DR diet) 

### Females only

```{r}
earlyPoorF <- subset(eelifeF, eelifeF$larvalTreat=="DR")

epf <- survfit(Surv(age, status==2) ~ adultTreat,
                   conf.type = "log", 
                   conf.int = 0.95,
                   type = "kaplan-meier",
                   error = "greenwood",
                   data = earlyPoorF,)
summary(epf)$table[, "median"]

epf.plot <- ggsurvplot(epf, data = earlyPoorF, 
                     conf.int = FALSE,
                     palette = c("#999999", "#E69F00", 
                                 "#56B4E9", "#009E73"),
                     fun = "pct", 
                     surv.median.line = "hv",
                     font.x = c(font_size),
                     font.y = c(font_size),
                     font.tickslab = c(font_size),
                     font.main = 12,
                     risk.table = FALSE,
                     legend = c(0.9, 0.8),                     
                     title = "Early-Poor Females",
                     legend.labs = c("C", "DR"),
                     legend.title = "Adult Diet") +
  theme_survminer(font.main = 12)  +
  xlab("Age (days)")
epf.plot

# Test significance
survdiff(Surv(age, status==2) ~ adultTreat,
                     data = earlyPoorF, rho = 0) 

quantile(f_er1,  probs = c(0.1, 0.5, 0.9))

```

### Males only

```{r}
earlyPoorM <- subset(eelifeM, eelifeM$larvalTreat=="DR")

epm <- survfit(Surv(age, status == 2) ~ adultTreat,
                   conf.type = "log", 
                   conf.int = 0.95,
                   type = "kaplan-meier",
                   error = "greenwood",
                   data = earlyPoorM)

summary(epm)$table[, "median"]

epm.plot <- ggsurvplot(epm, data = earlyPoorM, 
                     conf.int = FALSE,
                     palette = c("#999999", "#E69F00", 
                                 "#56B4E9", "#009E73"),
                     fun = "pct", 
                     surv.median.line = "hv",
                     font.x = c(font_size),
                     font.y = c(font_size),
                     font.tickslab = c(font_size),
                     font.main = 12,
                     risk.table = FALSE,
                     legend = c(0.9, 0.8),                     
                     title = "Early-Rich Males",
                     legend.labs = c("C", "DR"),
                     legend.title = "Adult Diet") +
  theme_survminer(font.main = 12) +
  xlab("Age (days)")
epm.plot

survdiff(Surv(age, status ==2) ~ adultTreat,
                     data = earlyPoorM, rho = 0) 
```

# CoxPH models 

Assupmtion: Proportional hazards (effects of all covariates do not change over time)
Non-PH therefore under- or overestimated risk

PH assumption (i.e. residuals independent of time) violated
Early:Adult diet interaction sig, albeit skewed residuals
Intearction of non-PH variables with age non-convergent (diet interacts heavily with age - nothing else is significant)
Models on age-classes not significant for either diet, but a large effect of sex.

Larval treatment effect depends on adult age 

```{r}

# All together
cph1 <- coxph(Surv(age, status==2) ~ larvalTreat + adultTreat + sex, 
                   data = eelife)
cph1
#ggforest(cph1, data = eelife)
test.cph1 <- cox.zph(cph1)
test.cph1
ggcoxzph(test.cph1)


cph2 <- coxph(Surv(age, status==2) ~ larvalTreat+sex + adultTreat + 
              larvalTreat:adultTreat, data = eelife)
cph2
#ggforest(cph2, data = eelife)
test.cph2 <- cox.zph(cph2)
test.cph2
ggcoxzph(test.cph2)


# Hazards are unproportional in both models 
# see Fox and Weisberg (2018)

# 1. Try interactions with age for non-PH variables (larvalTreat, sex)
cph3 <- coxph(Surv(age, status==2) ~ larvalTreat + adultTreat + 
                larvalTreat:adultTreat + 
                larvalTreat:age + sex + sex:age, data = eelife)
# Does not converge
cph3
#ggforest(cph1, data = eelife)
test.cph3 <- cox.zph(cph3)
test.cph3
ggcoxzph(test.cph3)


# 2. Stratify the time variable

hist(eelife$age)

eelife$age.intv <- car::recode(eelife$age, 
                              "lo:19=1; 
                              20:39=2; 
                              40:59=3; 
                              60:79=4; 
                              80:hi=5") 
xtabs(~ age.intv, data=eelife)

cph4 <- coxph(Surv(age, status==2) ~ larvalTreat + adultTreat + sex + 
                    strata(age.intv), data=eelife)
cph4

test.cph4 <- cox.zph(cph4)
test.cph4
ggcoxzph(test.cph4)
# Sex and global p-vals are still non-proportional


# Add interaction back
cph5 <- coxph(Surv(age, status==2) ~ adultTreat + larvalTreat + sex + 
                    larvalTreat:adultTreat,strata(age.intv),
              data=eelife)
cph5
# ‘floor’ not meaningful for factors


```

# Cox model with split-time variable

Unsplit-time variable: Adult treatment has a large effect. Sex has a large treatment.Larval treat and sex have very non-PH

Split-time variable: Adult treatment and sex have large effects. Larval treat and sex have non-PH

Splitting at interval of 0.5: Both treatments have PHs, but sex is still very much confounding.

```{r}

eelife <- read.csv("../processed/eeAlldat.csv") %>%
  select(-c(X,cageID,larv_adult))

eelife <- eelife %<>% 
  mutate(status = factor(status),
        larvalTreat = factor(larvalTreat),
        adultTreat = factor(adultTreat),
        sex = factor(sex))



# Now we can fit a regular cox regression:

regular_model <- coxph(Surv(age, status == 2) ~ larvalTreat + 
                         adultTreat + sex, data = eelife,
                       x = TRUE, y = TRUE)
summary(regular_model)
cox.zph(regular_model)


# Now, split dataset and repeat model

spl_eelife <-
  eelife %>% 
  timeSplitter(by = 0.5,
               event_var = "status",
               event_start_status = 3,
               time_var = "age")

interval_model <-
  update(regular_model, 
         Surv(Start_time, Stop_time, status == 2) ~ .,
         data = spl_eelife)

summary(interval_model)

# The difference between the models should be negligible:

cbind(Regular = coef(regular_model),
      Interval = coef(interval_model),
      Difference = coef(regular_model) - coef(interval_model)) %>% 
  txtRound(digits = 5) %>% 
  knitr::kable(align = "r")


# Now, look for time varying coefficients with survival::cox.zph() 

cox.zph(regular_model) %>% 
  extract2("table") %>% 
  txtRound(digits = 2) %>% 
  knitr::kable(align = "r")

# larvalTreat and sex are time-variable


# Update split-time model with interaction

time_int_model <- 
  update(interval_model,
         .~.+larvalTreat:Start_time,
         .~.+sex:Start_time)
summary(time_int_model)

sx <- cox.zph(time_int_model)
sx

ggcoxzph(sx)

#ggforest(time_int_model, data = spl_eelife)

ggforest(
  time_int_model,
  data = spl_eelife,
  main = NULL,
  cpositions = c(0.02, 0.22, 0.4),
  fontsize = 0.7,
  refLabel = "reference",
  noDigits = 2
)



# Adjusted survival curve for cox model
ggadjustedcurves(regular_model, data = eelife,
                    variable  = eelife[, "larvalTreat"],
                   legend.title = "Larval Treatment", )
```



## Sexes separately (to remove confounding effects of sex)

PH assumption violated
Intearction of non-PH variables with age non-convergent (adultTrt sig)
Models on age-classes not significant for either diet


### Females

Unsplit model: Adult treat highly sig; but adult treat has non-PH

Split model: At 0.5, adult treat remains highly sig; Adult treatment depends on age very significantly; All hazards are proportional!

This looks like a valid solution.

```{r}
eelife <- read.csv("../processed/eeAlldat.csv") %>%
  select(-c(X,cageID,larv_adult))

female <- subset(eelife, eelife$sex=="F")

female <- female %>% 
  mutate(status = factor(status),
        larvalTreat = factor(larvalTreat),
        adultTreat = factor(adultTreat),
        sex = factor(sex))


# Fit a regular cox model
regular_model <- coxph(Surv(age, status == 2) ~ larvalTreat + 
                         adultTreat, data = female)
summary(regular_model)
cox.zph(regular_model)


# Now, split dataset and repeat model

spl_female <-
  female %>% 
  timeSplitter(by = 0.5,
               event_var = "status",
               event_start_status = 3,
               time_var = "age")

interval_model <-
  update(regular_model, 
         Surv(Start_time, Stop_time, status == 2) ~ .,
         data = spl_female)

summary(interval_model)


# The difference between the models should be negligible:

cbind(Regular = coef(regular_model),
      Interval = coef(interval_model),
      Difference = coef(regular_model) - coef(interval_model)) %>% 
  txtRound(digits = 5) %>% 
  knitr::kable(align = "r")


# Now, look for time varying coefficients with survival::cox.zph() 

cox.zph(regular_model) %>% 
  extract2("table") %>% 
  txtRound(digits = 2) %>% 
  knitr::kable(align = "r")

# adultTreat is time-variable


# Update split-time model with interaction

time_int_model <- 
  update(interval_model,
         .~.+adultTreat:Start_time)
summary(time_int_model)

sx <- cox.zph(time_int_model)
sx

ggcoxzph(sx)

#ggforest(time_int_model, data = spl_eelife)

FF <- ggforest(
  time_int_model,
  data = spl_female,
  main = NULL,
  cpositions = c(0.02, 0.22, 0.4),
  fontsize = 0.7,
  refLabel = "reference",
  noDigits = 2
)

ggsave(FF,filename = "~/MyGithub/early_experience/Plots/Female_Greg_Forest_HR.pdf", height=3, width=6)

```

### Males

Unsplit model: Adult DR is higly sig in males also; Both larval and adult treat are non-PH.

Split model: Has larval treat sig also (P=0.0195), with PHs for both larval treat and larval treat*time; However, non-PH for adult treat.

This seems a satisfactory solution since we are interested in larval diet.

```{r}
eelife <- read.csv("../processed/eeAlldat.csv") %>%
  select(-c(X,cageID,larv_adult))

male <- subset(eelife, eelife$sex=="M")

male <- male %>% 
  mutate(status = factor(status),
        larvalTreat = factor(larvalTreat),
        adultTreat = factor(adultTreat),
        sex = factor(sex))


# Fit a regular cox model
regular_model <- coxph(Surv(age, status == 2) ~ larvalTreat + 
                         adultTreat, data = male)
summary(regular_model)
cox.zph(regular_model)


# Now, split dataset and repeat model

spl_male <-
  male %>% 
  timeSplitter(by = 0.5,
               event_var = "status",
               event_start_status = 3,
               time_var = "age")

interval_model <-
  update(regular_model, 
         Surv(Start_time, Stop_time, status == 2) ~ .,
         data = spl_male)

summary(interval_model)


# The difference between the models should be negligible:

cbind(Regular = coef(regular_model),
      Interval = coef(interval_model),
      Difference = coef(regular_model) - coef(interval_model)) %>% 
  txtRound(digits = 5) %>% 
  knitr::kable(align = "r")


# Now, look for time varying coefficients with survival::cox.zph() 

cox.zph(regular_model) %>% 
  extract2("table") %>% 
  txtRound(digits = 2) %>% 
  knitr::kable(align = "r")

# both variables are time-nonrandom


# Update split-time model with interaction

time_int_model <- 
  update(interval_model,
         .~.+larvalTreat:Start_time,
         .~.+adultTreat:Start_time)
summary(time_int_model)

sx <- cox.zph(time_int_model)
sx
#adultTreat still non-PH

ggcoxzph(sx)

#ggforest(time_int_model, data = spl_eelife)

MM <- ggforest(
  time_int_model,
  data = spl_male,
  main = NULL,
  cpositions = c(0.02, 0.22, 0.4),
  fontsize = 0.7,
  refLabel = "reference",
  noDigits = 2
)

ggsave(FF,filename = "~/MyGithub/early_experience/Plots/male_Greg_Forest_HR.pdf", height=3, width=6)


# Diagnostics


## Influential cases

# typeof residuals on Y axis: c(“martingale”, “deviance”, “score”, “schoenfeld”, “dfbeta”, “dfbetas”, “scaledsch”, “partial”).
lin_mm <- ggcoxdiagnostics(time_int_model, type = "dfbeta",
                 linear.predictions = FALSE, ggtheme = theme_bw())

ggsave(lin_mm,filename = "~/MyGithub/early_experience/Plots/male_nonlinearity_test.pdf", height=5, width=9)


### Visualize deviance residuals to check for outliers

dev_mm <- ggcoxdiagnostics(time_int_model, type = "deviance",
                 linear.predictions = FALSE, ggtheme = theme_bw())

dev_reg <- ggcoxdiagnostics(interval_model, type = "deviance",
                 linear.predictions = FALSE, ggtheme = theme_bw())

ggsave(dev_mm,filename = "~/MyGithub/early_experience/Plots/male_deviance_test.pdf", height=5, width=9)


## Testing non-linearity
### i.e. checking if functional form of model is correcctly specified

ggcoxfunctional(Surv(age, status==2) ~ age + log(age) + sqrt(age), data = male)
```




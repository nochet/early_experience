---
title: "The Cox model"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(survival)
library(survminer)
library(coxme)
library(splines) #needed by survival package
library(tidyverse) 
library(forcats)
library(cowplot)
library(Greg)

```

# CoxPH models 

## Summary results

Assupmtion: Proportional hazards (effects of all covariates do not change over time)
Non-PH therefore under- or overestimated risk

Looks like the simplest model (larv + adult + sex) is prefered whether the data is split by sex or not

Use this to correct the PH assumption

Use this to fit a Bayesiam model


# Data

```{r}
eelife <- read.csv("../processed/eeAlldat.csv") %>%
  select(-X,cageID,larv_adult,larvalTreat,adultTreat,age,status,sex) 

```

# With a 3-way interaction

cageID always sig - fit as random effect
Sex always sig - always include as fixed effect
All, except adult diet non-PH
see Fox and Weisberg (2018)

cph1.2 is better (`~ larvalTreat + adultTreat + sex`)

```{r}
# 3-way interaction (drop cageID in the interaction term)
cph1.0 <- coxph(Surv(age, status) ~ larvalTreat + adultTreat + 
                sex + cageID + larvalTreat:adultTreat:sex, 
              data = eelife)
summary(cph1)
cox.zph(cph1)


cph1.1 <- coxph(Surv(age, status) ~ larvalTreat + adultTreat + 
                sex + cageID, data = eelife)
summary(cph1.1)
# There's robust effect of sex and cage, larval diet at 10% sig, 
# adult diet nsig


cph1.2 <- coxph(Surv(age, status) ~ larvalTreat + adultTreat + 
                sex, data = eelife)
summary(cph1.2)
cox.zph(cph1.2)
# Robust effect of adult diet and sex, larval diet nsig


cph1.3 <- coxph(Surv(age, status) ~ larvalTreat + adultTreat,
                data = eelife)
summary(cph1.3)
cox.zph(cph1.3)
# Robust effect of adult diet, larval diet nsig
# Meets PH assumption in all terms

anova(cph1.3,cph1.2,cph1.1,cph1.0)
# Sex and cage have valid potential effects
# cph1.2 is more robust

# Fit the interaction term only
eelife <- eelife %>% unite(cpd_var, larv_adult, sex, 
                           sep = "_", remove = FALSE)

cph2 <- coxph(Surv(age, status) ~ cpd_var, data = eelife)
summary(cph2)
cox.zph(cph2)

# All 3-way interaction combis sig (due to sex & adult diet??)

# Compare again
anova(cph1.3,cph1.2,cph1.1,cph2)

# Compared to simplest model, model with sex but no cage more robust
# Model with 3-way interaction only similar to model with sex and cage
```

## cageID as random effect

Two of seven 3-way interactions not sig.
Two combis involving cageID sig.
Very non-PH

```{r}
eelife$status <- as.numeric(eelife$status)

cph3 <- coxme(Surv(age, status) ~ cpd_var + (1 | cageID), data = eelife)
summary(cph3)

anova(cph1.3,cph1.2,cph1.1,cph2,cph3)

# A random effect seems unfavored
# 3-way interaction alone seems similar to additive model with cageID
# Additive model with sex but no cageID most robust of all
# Select cph1.2 (larval diet has no effect)

```


## Take from linear models
1. LOOKS LIKE SEX HAS A MAJOR IMPACT - CONSIDER SEXES SEPARATELY LATER
2. DEAL WITH NON-PH COVARIATES
4. ONLY EFFECTS APPEAR AS INTERACTION (ABSENT WHEN FITTED AS ADDITIVE)



## Sexes separately (to remove confounding effects of sex)

PH assumption violated
Intearction of non-PH variables with age non-convergent (adultTrt sig)
Models on age-classes not significant for either diet


### Females

`~ larvalTreat + adultTreat` appears adequate

```{r}
female <- subset(eelife, eelife$sex=="F")

fph1.0 <- coxph(Surv(age, status) ~ larvalTreat + adultTreat + 
                cageID + larvalTreat:adultTreat:cageID, 
              data = female)
summary(fph1.0)
# Only cage has effect in 2 combis


fph1.1 <- coxph(Surv(age, status) ~ larvalTreat + adultTreat + 
                cageID, data = female)
summary(fph1.1)
# Only cage has effect in 2 combis


fph1.2 <- coxph(Surv(age, status) ~ larvalTreat + adultTreat, 
                data = female)
summary(fph1.2)
cox.zph(fph1.2)
# Adult diet robustly sig


fph1.3 <- coxph(Surv(age, status) ~ larv_adult, 
                data = female)
summary(fph1.3)
cox.zph(fph1.3)
# All combis sig; C_DR is robust negative effect


fph2 <- coxme(Surv(age, status) ~ larv_adult + (1 | cageID), 
              data = female)
summary(fph2)


fph2.1 <- coxme(Surv(age, status) ~ larvalTreat + adultTreat + 
                (1 | cageID), 
                data = female)
summary(fph2.1)
# Adult treat sig

anova(fph1.3,fph1.2,fph1.1,fph1.0,fph2,fph2.1)

# It seemms the simplest (fph1.2) is equally plausible to a model with additive cageID term(fph1.1), and one with RE on 2-way interaction (fph2)
```

### Males

Again, the simplest model (`~ larvalTreat + adultTreat`) appears adequate

```{r}
male <- subset(eelife, eelife$sex=="M")

mph1.0 <- coxph(Surv(age, status) ~ larvalTreat + adultTreat + 
                cageID + larvalTreat:adultTreat:cageID, 
              data = male)
summary(mph1.0)
# No effects are detectable


mph1.1 <- coxph(Surv(age, status) ~ larvalTreat + adultTreat + 
                cageID, data = male)
summary(mph1.1)
# No detectable effects


mph1.2 <- coxph(Surv(age, status) ~ larvalTreat + adultTreat, 
                data = male)
summary(mph1.2)
cox.zph(mph1.2)
# Adult diet robustly sig


mph1.3 <- coxph(Surv(age, status) ~ larv_adult, 
                data = male)
summary(mph1.3)
cox.zph(mph1.3)
# Two interactions robustly sig (larv_adultC_DR and larv_adultDR_DR)


mph2 <- coxme(Surv(age, status) ~ larv_adult + (1 | cageID), 
              data = male)
summary(mph2)
# Two interactions robustly sig (larv_adultC_DR and larv_adultDR_DR)


mph2.1 <- coxme(Surv(age, status) ~ larvalTreat + adultTreat + 
                (1 | cageID), 
                data = male)
summary(mph2.1)
# Adult treat robustly sig

anova(mph1.2,mph1.1,mph1.3,mph1.0,mph2,mph2.1)

# None is sig better than the simplest (mph1.2)
# non-PH though

```

# Correct the preferred model for PH
# No random effects needed


```{r}
# Fit a regular cox model
regular_modelF <- coxph(Surv(age, status) ~ larvalTreat + 
                         adultTreat, data = female)
summary(regular_modelF)
cox.zph(regular_modelF)


# Now, split dataset and repeat model

spl_female <-
  female %>% 
  timeSplitter(by = 5,
               event_var = "status",
               event_start_status = 0,
               time_var = "age")

interval_modelF <-
  update(regular_modelF, 
         Surv(Start_time, Stop_time, status == 1) ~ .,
         data = spl_female)

summary(interval_modelF)


# The difference between the models should be negligible:

cbind(Regular = coef(regular_modelF),
      Interval = coef(interval_modelF),
      Difference = coef(regular_modelF) - coef(interval_modelF)) %>% 
  txtRound(digits = 5) %>% 
  knitr::kable(align = "r")


# Now, look for time varying coefficients with survival::cox.zph() 

cox.zph(regular_modelF) %>% 
  extract2("table") %>% 
  txtRound(digits = 2) %>% 
  knitr::kable(align = "r")

# adultTreat is time-variable


# Update split-time model with interaction

time_int_modelF <- 
  update(interval_modelF,
         .~.+adultTreat:Start_time)
summary(time_int_modelF)

cox.zph(time_int_modelF)
#ggcoxzph(sx)
#ggforest(time_int_model, data = spl_eelife)

FF <- ggforest(
  time_int_modelF,
  data = spl_female,
  main = NULL,
  cpositions = c(0.02, 0.22, 0.4),
  fontsize = 0.7,
  refLabel = "reference",
  noDigits = 2
)

FF

ggsave(FF,filename = "~/MyGithub/early_experience/Plots/Female_Greg_Forest_HR.pdf", height=3, width=6)

```

### Males

Unsplit model: Adult DR is highly sig in males also; Both larval and adult treat are non-PH.

Split model: Has larval treat sig also (P=0.0195), with PHs for both larval treat and larval treat*time; However, non-PH for adult treat.

This seems a satisfactory solution since we are interested in larval diet.

```{r}

male <- subset(eelife, eelife$sex=="M")

# male <- male %>% 
#   mutate(status = factor(status),
#         larvalTreat = factor(larvalTreat),
#         adultTreat = factor(adultTreat),
#         sex = factor(sex))


# Fit a regular cox model
regular_modelM <- coxph(Surv(age, status) ~ larvalTreat + 
                         adultTreat, data = male)
summary(regular_modelM)
cox.zph(regular_modelM)


# Now, split dataset and repeat model

spl_male <-
  male %>% 
  timeSplitter(by = 5,
               event_var = "status",
               event_start_status = 0,
               time_var = "age")

interval_modelM <-
  update(regular_modelM, 
         Surv(Start_time, Stop_time, status == 1) ~ .,
         data = spl_male)

summary(interval_modelM)


# The difference between the models should be negligible:

cbind(Regular = coef(regular_modelM),
      Interval = coef(interval_modelM),
      Difference = coef(regular_modelM) - coef(interval_modelM)) %>% 
  txtRound(digits = 5) %>% 
  knitr::kable(align = "r")


# Now, look for time varying coefficients with survival::cox.zph() 

cox.zph(regular_modelM) %>% 
  extract2("table") %>% 
  txtRound(digits = 2) %>% 
  knitr::kable(align = "r")

# both variables are time-nonrandom


# Update split-time model with interaction

time_int_modelM <- 
  update(interval_modelM,
         .~.+larvalTreat:Start_time,
         .~.+adultTreat:Start_time)
summary(time_int_modelM)

cox.zph(time_int_modelM)

#adultTreat still non-PH

#ggcoxzph(sx)

#ggforest(time_int_model, data = spl_eelife)

MM <- ggforest(
  time_int_modelM,
  data = spl_male,
  main = NULL,
  cpositions = c(0.02, 0.22, 0.4),
  fontsize = 0.7,
  refLabel = "reference",
  noDigits = 2
)
MM

ggsave(MM,filename = "~/MyGithub/early_experience/Plots/male_Greg_Forest_HR.pdf", height=3, width=6)
```




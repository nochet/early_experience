---
title: "Parametric analysis"
author: "Enoch Ng'oma"
date: "2/17/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse) 
library(cowplot)
library(survival)
library(survminer)
library(flexsurv)
library(rms)

source("color_map.R")

set.seed(428)

```

# Data

```{r}
eelife <- read.csv("../processed/eeAlldat.csv", header=TRUE)
names(eelife)[1]<-"event"
head(eelife)

eelife <- eelife[complete.cases(eelife),]
```

```{r}
#Weibull
pm1 <- flexsurvreg(Surv(age, status == 2) ~ larv_adult, 
                   data = eelife, dist = "weibull")
pm1

# Generalized gamma
pm2 <- flexsurvreg(Surv(age, status == 2) ~ larv_adult, 
                   data = eelife, dist = "gengamma")
pm2

#Generalized gamma
pm3 <- flexsurvreg(Surv(age, status == 2) ~ larv_adult + sigma(larv_adult), 
                   data = eelife, dist = "gengamma")
pm3

pm31 <- flexsurvreg(Surv(age, status == 2) ~ larv_adult, 
                    data = eelife, anc = list(sigma = ~ larv_adult), 
                    dist = "gengamma")
pm31

#Sex
pm4 <- flexsurvreg(Surv(age, status == 2) ~ larv_adult + sex, 
                    data = eelife, dist = "gengamma")
pm4

```

# Plot log of hazard ratio

```{r}
# Forestplot

#########################
library(survival)
library(rms)
ddist <- datadist(ovarian)
options(datadist='ddist')

ovarian$rx <- factor(ovarian$rx)
fit1 = cph(Surv(futime, fustat) ~ rx + rcs(age, 3), ovarian, x=TRUE, y=TRUE)

# The plot.summary.rms
plot(summary(fit1, age=c(50,60)), q=c(.6, .8, .95), log=T, 
                 col=c("orange", "gold", "blue"))

#########################

# Example
# fit.coxph <- coxph(surv_object ~ rx + resid.ds + age_group + ecog.ps, 
#                    data = ovarian)

eelife$larv_adult <- factor(eelife$larv_adult)

trt <- coxph(Surv(NewAge, status==2) ~ larv_adult, 
                   data = eelife)
ggforest(trt, data = eelife)

tsex <- coxph(Surv(NewAge, status==2) ~ larv_adult + Sex, 
                   data = eelife)
ggforest(tsex, data = eelife)


tadult <- coxph(Surv(NewAge, status==2) ~ larv_adult + adultTreat, 
                   data = eelife)
ggforest(tadult, data = eelife)


fit1 = cph(Surv(NewAge, status==2) ~ larv_adult, eelife, x=TRUE, y=TRUE)

# The plot.summary.rms
plot(summary(fit1, age=c(50,60)), q=c(.6, .8, .95), log=T, 
                 col=c("orange", "gold", "blue"))

```



---
title: "The Cox model"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(survival)
library(survminer)
library(coxme)
library(coxphw)
library(splines) 
library(tidyverse) 
library(forcats)
library(car)
library(broom)
library(AICcmodavg)

library(sjPlot)
library(sjmisc)
library(sjlabelled) 
```

# Data

```{r}
eelife <- read.csv("../processed/eeAlldat.csv") %>%
  select(-X,cageID,larv_adult,larvalTreat,adultTreat,age,status,sex) 

# cols <- c("cageID", "larv_adult", "larvalTreat", "adultTreat","sex")
# eelife[cols] <- lapply(eelife[cols], factor)  
eelife$age <- as.numeric(eelife$age)
eelife$status <- as.numeric(eelife$status)
# sapply(eelife, class)

```

# A full model

Addressing non-proportional hazards: https://cran.r-project.org/web/packages/Greg/vignettes/timeSplitter.html
vignette("timedep", package = "survival")

```{r}
imod1.0 <- coxph(Surv(age, status) ~  larvalTreat + adultTreat + 
                   larvalTreat*adultTreat + sex + cluster(cageID), 
                 data = eelife)
summary(imod1.0) 
cox.zph(imod1.0) # very NPH

# extractAIC(imod1.0)
# tidy(imod1.0,exponentiate = TRUE)
# glance(imod1.0)
# plot(survfit(imod1.0, transform="km", global=TRUE))
# plot(cox.zph(imod1.0,transform="km", global=TRUE))
# tab_model(imod1.0,file="additiveMod.doc")

# Stratify on sex (cageID cannot be stratified)
imod1.1 <- coxph(Surv(age, status) ~  larvalTreat + adultTreat + 
                   larvalTreat*adultTreat + strata(sex) + cluster(cageID), 
                 data = eelife)
summary(imod1.1)
survfit(imod1.1) # estimates K different baseline hazardfunctions, one for each stratum
cox.zph(imod1.1) # still NPH, due to cageID

anova(imod1.0,imod1.1)
# Stratifying improves model, but still NPH

aictab(list(imod1.0,imod1.1)) # imod1.1 is better (i.e. stratified)


# An alternate approach: Weighted estimation
ialt1.0 <- coxphw(Surv(age,status) ~ larvalTreat + adultTreat + 
                   larvalTreat*adultTreat + strata(sex) + cageID, 
                  data=eelife, template = "AHR" )
# template = PH for unweighted coxph; 
# template = ARE for estimation of average hazard ratios
# template = AHR for estimation of average hazard ratios

summary(ialt1.0)

```

# Cage as random effect

```{r}
imod1.2 <- coxme(Surv(age, status) ~ larvalTreat + adultTreat + 
                  larvalTreat*adultTreat + strata(sex) +
                  (1 | cageID), data = eelife)
summary(imod1.2) 
# Interaction not sig.
car::Anova(imod1.2, type="II")
# car::Anova(imod1.2, type="III"); use only if no interactions are involved

anova(imod1.1, imod1.2)
# cageID cannot be ignored

```

# Model test (individual life stage diet effects)

```{r}
imod1.2.1 <- coxph(Surv(age, status) ~ larvalTreat + adultTreat + cageID +
                     larvalTreat*adultTreat + 
                     strata(sex), data = eelife)

imod1.2.2 <- coxph(Surv(age, status) ~ larvalTreat + adultTreat + 
                     larvalTreat*adultTreat + 
                     strata(sex), data = eelife)

imod4.1.0 <- coxph(Surv(age, status) ~ larvalTreat + adultTreat + 
                     larvalTreat*adultTreat + cageID, data = eelife)

imod4.1.1 <- coxph(Surv(age, status) ~ larvalTreat + adultTreat + 
                     larvalTreat*adultTreat , data = eelife)

imod4.1.2 <- coxph(Surv(age, status) ~ larvalTreat + adultTreat + 
                     strata(sex), data = eelife)

imod4.1.3 <- coxph(Surv(age, status) ~  
                     strata(sex), data = eelife)
#coef(imod4.1.3)

aictab(list(imod1.2.1, imod1.2.2, imod4.1.0, imod4.1.1,
            imod4.1.2, imod4.1.3))
# imod1.2.1 is best; imod1.2.2 almost tying

anova(imod1.2.1, imod1.2.2)
# Looks like cageID can/can't be ignored

rm(imod1.2.1, imod1.2.2, imod4.1.0, imod4.1.1,
   imod4.1.2, imod4.1.3)
```

# Test for sex-by-diet interaction (individual life stage diet effects)

```{r}

# Females

eelifeF <- eelife %>%
  filter(sex=="F")

imod1.2.0 <- coxph(Surv(age, status) ~ larvalTreat + adultTreat + 
                     larvalTreat*adultTreat + cageID, 
                   data = eelifeF)
summary(imod1.2.0) # cage effects in 2 cages
cox.zph(imod1.2.0) # NPH; NPH when adult is strata; NA when cage is strata
# Since cage has a small effect, can be ignored
coef(imod1.2.0)

imod1.2.1 <- coxph(Surv(age, status) ~ larvalTreat + strata(adultTreat) + 
                  larvalTreat*adultTreat, data = eelifeF)
coef(imod1.2.1)
summary(imod1.2.1) # identical to imod1.2.0
cox.zph(imod1.2.1) # PH
# Looks good

imod1.2.2 <- coxph(Surv(age, status) ~ larvalTreat + strata(adultTreat), 
                   data = eelifeF)
coef(imod1.2.2)
summary(imod1.2.2)
cox.zph(imod1.2.2) # PH

anova(imod1.2.0,imod1.2.1, imod1.2.2)
# Clearly model without cage performs best (larger likelihood)

aictab(list(imod1.2.0,imod1.2.1, imod1.2.2))
# Model without cage is better (lower AICc)



# Males

eelifeM <- eelife %>%
  filter(sex=="M")

imod1.2.3 <- coxph(Surv(age, status) ~ larvalTreat + strata(adultTreat) + 
                     larvalTreat*adultTreat + cageID, data = eelifeM)
summary(imod1.2.3) # cage effects in 2 cages
cox.zph(imod1.2.3) # NPH; NPH when adult is strata; NA when cage is strata
# Since cage has a small effect, can be ignored
coef(imod1.2.3)

imod1.2.4 <- coxph(Surv(age, status) ~ larvalTreat + strata(adultTreat) + 
                  larvalTreat*adultTreat, data = eelifeM)
coef(imod1.2.4)
summary(imod1.2.4) # identical to imod1.2.0
cox.zph(imod1.2.4) # PH
# Looks good

imod1.2.5 <- coxph(Surv(age, status) ~ larvalTreat + strata(adultTreat), 
                   data = eelifeM)
coef(imod1.2.5)
summary(imod1.2.5)
cox.zph(imod1.2.5) # PH

anova(imod1.2.3,imod1.2.4, imod1.2.5)
# Models not significantly different

aictab(list(imod1.2.3,imod1.2.4, imod1.2.5))
# Simplest model (imod1.2.5) is better

rm(imod1.2.0,imod1.2.1, imod1.2.2,imod1.2.3,imod1.2.4, imod1.2.5)
```

# Combined effect of larval-adult diets

```{r}
cmod1.0 <- coxph(Surv(age, status) ~ larv_adult + 
                     larvalTreat*adultTreat + 
                   strata(sex) + cageID, data = eelife)
cox.zph(cmod1.0) # NPH
summary(cmod1.0)

cmod1.1 <- coxph(Surv(age, status) ~ larv_adult + 
#                     larvalTreat*adultTreat + 
                   strata(sex), data = eelife)
cox.zph(cmod1.1) # PH
summary(cmod1.1)

cmod1.2 <- coxph(Surv(age, status) ~  larv_adult + 
                   larvalTreat*adultTreat, data = eelife)
cox.zph(cmod1.2) # PH
summary(cmod1.2)

aictab(list(cmod1.1, cmod1.2))
# cmod1.1 is better


```

# Combined effect of sex-by-larval_adult diet effects
# There are sig S-by-L diet effects - diet affects female lifespan

```{r}
# Females (effects)

smod1.2.0 <- coxph(Surv(age, status) ~ larvalTreat + strata(adultTreat) + 
                     larv_adult + cageID, data = eelifeF)
summary(smod1.2.0) # cage effects in 1 cage
cox.zph(smod1.2.0) # NPH

smod1.2.1 <- coxph(Surv(age, status) ~ larvalTreat + strata(adultTreat) + 
                     larv_adult, data = eelifeF)
summary(smod1.2.1) 
cox.zph(smod1.2.1) # PH

smod1.2.2 <- coxph(Surv(age, status) ~ larvalTreat + strata(adultTreat), 
                   data = eelifeF)
summary(smod1.2.2) 
cox.zph(smod1.2.2) # PH

smod1.2.3 <- coxph(Surv(age, status) ~ larvalTreat, 
                   data = eelifeF)
summary(smod1.2.3) 
cox.zph(smod1.2.3) # PH

smod1.2.4 <- coxph(Surv(age, status) ~ adultTreat, 
                   data = eelifeF)
summary(smod1.2.4) 
cox.zph(smod1.2.4) # NPH

aictab(list(smod1.2.1, smod1.2.2, smod1.2.3))
anova(smod1.2.1, smod1.2.2)
# smod1.2.1 is best


# Males # No effects
smod1.3.0 <- coxph(Surv(age, status) ~ larvalTreat + strata(adultTreat) + 
                     larv_adult + cageID, data = eelifeM)
summary(smod1.3.0) # cage effects in 1 cage
cox.zph(smod1.3.0) # PH

smod1.3.1 <- coxph(Surv(age, status) ~ larvalTreat + strata(adultTreat) + 
                     larv_adult, data = eelifeM)
summary(smod1.3.1) 
cox.zph(smod1.3.1) # PH

smod1.3.2 <- coxph(Surv(age, status) ~ larvalTreat + strata(adultTreat), 
                   data = eelifeM)
summary(smod1.3.2) 
cox.zph(smod1.3.2) # PH

smod1.3.3 <- coxph(Surv(age, status) ~ larvalTreat, 
                   data = eelifeM)
summary(smod1.3.3) 
cox.zph(smod1.3.3) # NPH

smod1.3.4 <- coxph(Surv(age, status) ~ adultTreat, 
                   data = eelifeM)
summary(smod1.3.4) 
cox.zph(smod1.3.4) # NPH

aictab(list(smod1.3.1, smod1.3.2))
# smod1.3.2 is best
anova(smod1.3.1, smod1.3.2)
# smod1.2.1 is best
```

# Tables

```{r}
tab_model(imod1.2.1,imod1.2.2,cph2.1,cph2.2, file="selectedMods.doc")
tab_model(cph3.4, file = "coxmeNested") # spits error

rm(cph2.1.0,cph2.1.1,cph2.1.2,cph3.1.0,cph3.1.1,cph3.1.2,cph3.1.3)
```


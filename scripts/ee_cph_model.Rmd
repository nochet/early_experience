---
title: "The Cox model"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(survival)
library(survminer)
library(coxme)
library(coxphw)
library(splines) 
library(tidyverse) 
library(forcats)
library(car)
library(broom)
library(AICcmodavg)

library(sjPlot)
library(sjmisc)
library(sjlabelled) 
```

# Data

```{r}
eelife <- read.csv("../processed/eeAlldat.csv") %>%
  select(-X,cageID,larv_adult,larvalTreat,adultTreat,age,status,sex) 

# cols <- c("cageID", "larv_adult", "larvalTreat", "adultTreat","sex")
# eelife[cols] <- lapply(eelife[cols], factor)  
eelife$age <- as.numeric(eelife$age)
eelife$status <- as.numeric(eelife$status)
# sapply(eelife, class)

```

# A full model

Addressing non-proportional hazards: https://cran.r-project.org/web/packages/Greg/vignettes/timeSplitter.html
vignette("timedep", package = "survival")

```{r}
mod1.0 <- coxph(Surv(age, status) ~  larvalTreat + adultTreat + 
                   larvalTreat*adultTreat + sex + cluster(cageID), 
                 data = eelife)
summary(mod1.0) 
cox.zph(mod1.0) # very NPH

# extractAIC(mod1.0)
# tidy(mod1.0,exponentiate = TRUE)
# glance(mod1.0)
# plot(survfit(mod1.0, transform="km", global=TRUE))
# plot(cox.zph(mod1.0,transform="km", global=TRUE))
# tab_model(mod1.0,file="additiveMod.doc")

# Stratify on sex (cageID cannot be stratified)
mod1.1 <- coxph(Surv(age, status) ~  larvalTreat + adultTreat + 
                   larvalTreat*adultTreat + strata(sex) + 
                   cluster(cageID), data = eelife)
summary(mod1.1)
survfit(mod1.1) # estimates K different baseline hazard functions, one for each stratum
cox.zph(mod1.1) # PH
car::Anova(mod1.1, type="II")

# anova(mod1.0,mod1.1)
# Stratifying improves model, but still NPH

mod1.2 <- coxph(Surv(age, status) ~  larvalTreat + adultTreat + 
                   larv_adult*strata(sex) + 
                   cluster(cageID), data = eelife)
summary(mod1.2)
survfit(mod1.2) # estimates K different baseline hazard functions, one for each stratum
cox.zph(mod1.2) # NPH, due to interaction

aictab(list(mod1.0,mod1.1,mod1.2)) 
# mod1.1 is better (i.e. stratified)


# An alternate approach: Weighted estimation
ialt1.0 <- coxphw(Surv(age,status) ~ larvalTreat + adultTreat + 
                   larvalTreat*adultTreat + strata(sex) + cageID, 
                  data=eelife, template = "AHR" )
# template = PH for unweighted coxph; 
# template = ARE for estimation of average hazard ratios
# template = AHR for estimation of average hazard ratios

summary(ialt1.0)

```

# Cage as random effect
# cluster(ID) argument for coxph = random effects argument for coxme
# i.e. model mod1.1 generally similar to mod1.2

```{r}
mod1.2 <- coxme(Surv(age, status) ~ larvalTreat + adultTreat + 
                  larvalTreat*adultTreat + strata(sex) +
                  (1 | cageID), data = eelife)
summary(mod1.2) 
# Interaction not sig.
car::Anova(mod1.2, type="II")
# car::Anova(mod1.2, type="III"); use only if no interactions are involved

anova(mod1.1, mod1.2)
# cageID cannot be ignored

```

# Test for sex-by-diet interaction (individual life stage diet effects)
# Females

```{r}

eelifeF <- eelife %>%
  filter(sex=="F")

mod2.0 <- coxph(Surv(age, status) ~ larvalTreat + adultTreat + 
                     larvalTreat*adultTreat + cluster(cageID), 
                   data = eelifeF)
summary(mod2.0) 
cox.zph(mod2.0) # NPH
coef(mod2.0)

mod2.1 <- coxph(Surv(age, status) ~ larvalTreat + strata(adultTreat) + 
                  larvalTreat*adultTreat + cluster(cageID), data = eelifeF)
summary(mod2.1) 
cox.zph(mod2.1) # PH
# Looks good

mod2.2 <- coxph(Surv(age, status) ~ larvalTreat + strata(adultTreat) +
                 larvalTreat*adultTreat, data = eelifeF)
summary(mod2.2)
cox.zph(mod2.2) # PH

mod2.3 <- coxph(Surv(age, status) ~ larvalTreat + strata(adultTreat), 
                 data = eelifeF)
summary(mod2.3)
cox.zph(mod2.3) # PH

anova(mod1.2.0,mod1.2.1, mod1.2.2)
# Clearly model without cage performs best (larger likelihood)

aictab(list(mod2.0,mod2.1, mod2.2, mod2.3))
# Model mod2.1 ties with mod2.2: Support to ignore cage

anova(mod2.2)
# Highlights sig effect of interaction
```

# Males

```{r}
eelifeM <- eelife %>%
  filter(sex=="M")

mod3.0 <- coxph(Surv(age, status) ~ larvalTreat + adultTreat + 
                     larvalTreat*adultTreat + cluster(cageID), 
                   data = eelifeM)
summary(mod3.0) 
cox.zph(mod3.0) # NPH
coef(mod3.0)

mod3.1 <- coxph(Surv(age, status) ~ larvalTreat + strata(adultTreat) + 
                  larvalTreat*adultTreat + cluster(cageID), 
                 data = eelifeM)
summary(mod3.1) 
cox.zph(mod3.1) # NPH

mod3.2 <- coxph(Surv(age, status) ~ larvalTreat + strata(adultTreat) +
                 larvalTreat*adultTreat, data = eelifeM)
summary(mod3.2)
cox.zph(mod3.2) # NPH

mod3.3 <- coxph(Surv(age, status) ~ larvalTreat + strata(adultTreat), 
                 data = eelifeM)
summary(mod3.3)
cox.zph(mod3.3) # PH

aictab(list(mod3.0,mod3.1, mod3.2,mod3.3))
# Model mod2.1 ties with mod2.2: Support to ignore cage

```

# Combined effect of larval-adult diets

```{r}
mod4.0 <- coxph(Surv(age, status) ~ larvalTreat + adultTreat + 
                  larv_adult + strata(sex) + cluster(cageID), 
                data = eelife)
summary(mod4.0)
cox.zph(mod4.0) # PH

mod4.1 <- coxph(Surv(age, status) ~ larvalTreat + adultTreat + 
                  larv_adult + strata(sex), 
                data = eelife)
summary(mod4.1)
cox.zph(mod4.1) # PH

mod4.2 <- coxph(Surv(age, status) ~ larvalTreat + adultTreat + 
                  larv_adult, data = eelife)
summary(mod4.2)
cox.zph(mod4.2) # PH

aictab(list(mod4.0, mod4.1, mod4.2))
# mod4.0 and mod4.1 are better, but tie. Seems cage can be ignored

tab_model(mod1.1,mod1.2,mod4.0,mod4.1,mod4.2, file="AllDataMods.doc")

```

# Combined effect of sex-by-larval_adult diet effects
# There are sig S-by-L diet effects - diet affects female lifespan

```{r}
# Females (effects)

smod1.2.0 <- coxph(Surv(age, status) ~ larvalTreat + strata(adultTreat) + 
                     larv_adult + cageID, data = eelifeF)
summary(smod1.2.0) # cage effects in 1 cage
cox.zph(smod1.2.0) # NPH

smod1.2.1 <- coxph(Surv(age, status) ~ larvalTreat + strata(adultTreat) + 
                     larv_adult, data = eelifeF)
summary(smod1.2.1) 
cox.zph(smod1.2.1) # PH

smod1.2.2 <- coxph(Surv(age, status) ~ larvalTreat + strata(adultTreat), 
                   data = eelifeF)
summary(smod1.2.2) 
cox.zph(smod1.2.2) # PH

smod1.2.3 <- coxph(Surv(age, status) ~ larvalTreat, 
                   data = eelifeF)
summary(smod1.2.3) 
cox.zph(smod1.2.3) # PH

smod1.2.4 <- coxph(Surv(age, status) ~ adultTreat, 
                   data = eelifeF)
summary(smod1.2.4) 
cox.zph(smod1.2.4) # NPH

aictab(list(smod1.2.1, smod1.2.2, smod1.2.3))
anova(smod1.2.1, smod1.2.2)
# smod1.2.1 is best


# Males # No effects
smod1.3.0 <- coxph(Surv(age, status) ~ larvalTreat + strata(adultTreat) + 
                     larv_adult + cageID, data = eelifeM)
summary(smod1.3.0) # cage effects in 1 cage
cox.zph(smod1.3.0) # PH

smod1.3.1 <- coxph(Surv(age, status) ~ larvalTreat + strata(adultTreat) + 
                     larv_adult, data = eelifeM)
summary(smod1.3.1) 
cox.zph(smod1.3.1) # PH

smod1.3.2 <- coxph(Surv(age, status) ~ larvalTreat + strata(adultTreat), 
                   data = eelifeM)
summary(smod1.3.2) 
cox.zph(smod1.3.2) # PH

smod1.3.3 <- coxph(Surv(age, status) ~ larvalTreat, 
                   data = eelifeM)
summary(smod1.3.3) 
cox.zph(smod1.3.3) # NPH

smod1.3.4 <- coxph(Surv(age, status) ~ adultTreat, 
                   data = eelifeM)
summary(smod1.3.4) 
cox.zph(smod1.3.4) # NPH

aictab(list(smod1.3.1, smod1.3.2))
# smod1.3.2 is best
anova(smod1.3.1, smod1.3.2)
# smod1.2.1 is best
```

# Tables

```{r}
tab_model(mod1.2.1,mod1.2.2,cph2.1,cph2.2, file="selectedMods.doc")
tab_model(cph3.4, file = "coxmeNested") # spits error

rm(cph2.1.0,cph2.1.1,cph2.1.2,cph3.1.0,cph3.1.1,cph3.1.2,cph3.1.3)
```


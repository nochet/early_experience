---
title: "The Cox model"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(survival)
library(survminer)
library(coxme)
library(splines) 
library(tidyverse) 
library(forcats)
library(car)

```

# Data

```{r}
eelife <- read.csv("../processed/eeAlldat.csv") %>%
  select(-X,cageID,larv_adult,larvalTreat,adultTreat,age,status,sex) 

# cols <- c("cageID", "larv_adult", "larvalTreat", "adultTreat","sex")
# eelife[cols] <- lapply(eelife[cols], factor)  
eelife$age <- as.numeric(eelife$age)
# sapply(eelife, class)


```

# With a 3-way interaction

cageID always sig - fit as random effect
Sex always sig - always include as fixed effect
All, except adult diet non-PH
see Fox and Weisberg (2018)

Consider these two models:
~ larvalTreat + adultTreat + strata(sex) : cxph1.2.1
~ larvalTreat + adultTreat + cageID + strata(sex) : cxph1.2.2
~ larvalTreat + adultTreat + strata(sex) + (1 | cageID) # better, but cox.zph impossible
              
Addressing non-proportional hazards: https://cran.r-project.org/web/packages/Greg/vignettes/timeSplitter.html
vignette("timedep", package = "survival")

```{r}
# Null model (log likelihood= -20644.52)
null <- coxph(Surv(age, status) ~ 1, data=eelife)

cxph1.1 <- coxph(Surv(age, status) ~  larvalTreat*adultTreat + sex, 
                 data = eelife)
summary(cxph1.1) # some interaction effect
cox.zph(cxph1.1)
ggforest(cxph1.1, data = eelife)


cxph1.2.0 <- coxph(Surv(age, status) ~ larvalTreat + adultTreat + sex + 
                     larvalTreat*adultTreat, 
                   data = eelife)
summary(cxph1.2.0)
cox.zph(cxph1.2.0)
par(mfrow=c(2,2))
plot(cox.zph(cxph1.2.0))


cxph1.2.1 <- coxph(Surv(age, status) ~ larvalTreat + adultTreat + 
                     larvalTreat*adultTreat + 
                     strata(sex), data = eelife)
summary(cxph1.2.1)
cox.zph(cxph1.2.1)
#ggforest(cxph1.2, data = eelife) #undefined columns (strata??)
# Robust effect of adult diet, larval diet nsig
extractAIC(cxph1.2.1)
tidy(cxph1.2.1,exponentiate = TRUE)
glance(cxph1.2.1)
plot(survfit(cxph1.2.1, transform="km", global=TRUE))
plot(cox.zph(cxph1.2.1,transform="km", global=TRUE))
#termplot(cxph1.2, term=2, se=TRUE, col.term=1, col.se=1,ylab="log hazard")

cxph1.2.2 <- coxph(Surv(age, status) ~ larvalTreat + adultTreat + cageID +
                     larvalTreat*adultTreat + 
                     strata(sex), data = eelife)
summary(cxph1.2.2) # 2 cages have sig cage effects
anova(cxph1.2.2)
cox.zph(cxph1.2.2) # cageID NPH

anova(cxph1.1,cxph1.2.1,cxph1.2.2)

```

## cageID as random effect

```{r}
eelife$status <- as.numeric(eelife$status)
stem(table(eelife$cageID))

cph2.1 <- coxme(Surv(age, status) ~ larvalTreat + adultTreat + 
                  larvalTreat*adultTreat + strata(sex) +
                  (1 | cageID), 
                  data = eelife)
summary(cph2.1)
car::Anova(cph2.1, type="II")


cph2.2 <- coxme(Surv(age, status) ~ larv_adult + strata(sex) +
                larvalTreat*adultTreat + (1 | cageID), 
                data = eelife)
summary(cph3.2)

car::Anova(cph3.2, type="III")

# (1 | cageID) read as: intercept (effect) per cageID (group)

# ?anova.coxme
anova(cxph1.2.1,cxph1.2.2,cph3)
nrow(cph3)

# Get random effects coefficients using ranef()
stem(exp(ranef(cph3)[[1]]))

# To look at random treatment effects within center we can add a nested effect
cph3.1 <- coxme(Surv(age, status) ~ larvalTreat + adultTreat + sex +
                  (1 | cageID/larvalTreat), eelife)  
cph3.1

cph3.2 <- coxme(Surv(age, status) ~ larvalTreat + adultTreat + sex +
                  (1 | cageID/adultTreat), eelife)  
cph3.2

cph3.3 <- coxme(Surv(age, status) ~ larvalTreat + adultTreat + sex +
                  (1 | cageID/sex), eelife)  
cph3.3

# A random effect seems unfavored
# 3-way interaction alone seems similar to additive model with cageID
# Additive model with sex but no cageID most robust of all
# Select cph1.2 (larval diet has no effect)

```


## Take from linear models
1. sex has a big effect - `/script_sink/ee_coxph_models.Rmd addresses this`
4. cageID has a small effect (7%). Random effect can be ignored in Bayes model







